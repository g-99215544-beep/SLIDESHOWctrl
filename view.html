<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slideshow View (Local)</title>
  <style>
    :root{
      --bg:#000;
      --accent: rgba(255,255,255,.12);
      --text: #fff;
      --muted: rgba(255,255,255,.6);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }
    .stage{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
    }
    .media{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain; /* tukar ke cover jika mahu */
      opacity:0;
      transition: opacity .6s ease;
      background:#000;
    }
    .media.show{opacity:1;}
    .overlay{
      position:fixed;
      left:14px;
      bottom:10px;
      padding:6px 10px;
      border-radius:10px;
      background: rgba(0,0,0,.35);
      border:1px solid var(--accent);
      backdrop-filter: blur(6px);
      font-size:11px;
      color: var(--muted);
      display:flex; gap:10px; align-items:center;
      user-select:none;
    }
    .dot{
      width:6px; height:6px;
      border-radius:50%;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,.7);
    }
    .hint{
      position:fixed;
      right:14px;
      bottom:10px;
      padding:6px 10px;
      border-radius:10px;
      background: rgba(0,0,0,.35);
      border:1px solid var(--accent);
      backdrop-filter: blur(6px);
      font-size:11px;
      color: var(--muted);
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="stage" id="stage"></div>

  <div class="overlay">
    <span class="dot"></span>
    <span id="statusText">Local sync</span>
  </div>
  <div class="hint">Tekan <b>F11</b> untuk fullscreen</div>

<script>
const META_KEY = "slideshow_local_meta_v1";
const SETTINGS_KEY = "slideshow_local_settings_v1";
const DB_NAME = "slideshow_local_db_v1";
const STORE = "media";
const CHANNEL = "slideshow_local_channel_v1";

const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(CHANNEL) : null;

const stage = document.getElementById("stage");
const statusText = document.getElementById("statusText");

let settings = loadSettings();
let slides = sortSlides(loadMeta());
let idx = 0;
let timer = null;
let currentEl = null;
let lastObjectUrl = null;

// ---------- IDB ----------
function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbGet(id){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).get(id);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

// ---------- META ----------
function loadMeta(){
  try { return JSON.parse(localStorage.getItem(META_KEY) || "[]"); }
  catch { return []; }
}
function loadSettings(){
  try {
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null");
    return s || { defaultDurationSec: 6, updatedAt: Date.now() };
  } catch {
    return { defaultDurationSec: 6, updatedAt: Date.now() };
  }
}
function sortSlides(list){
  return [...list].sort((a,b) => {
    const ao = Number(a.order ?? 999999);
    const bo = Number(b.order ?? 999999);
    if (ao !== bo) return ao - bo;
    return Number(a.createdAt ?? 0) - Number(b.createdAt ?? 0);
  });
}

// ---------- UTILS ----------
function setStatus(msg){ statusText.textContent = msg; }
function clearTimer(){
  if (timer){ clearTimeout(timer); timer = null; }
}
function revokeLastUrl(){
  if (lastObjectUrl){
    try { URL.revokeObjectURL(lastObjectUrl); } catch {}
    lastObjectUrl = null;
  }
}
function getDuration(slide, videoEl){
  if (slide.durationSec && Number(slide.durationSec) > 0) return Number(slide.durationSec);
  if (slide.type === "video" && videoEl && Number(videoEl.duration) > 0 && isFinite(videoEl.duration)) {
    return Math.ceil(videoEl.duration);
  }
  return Number(settings.defaultDurationSec || 6);
}

// ---------- CREATE MEDIA ----------
async function createMediaEl(slide){
  revokeLastUrl();

  if (slide.type === "video"){
    const v = document.createElement("video");
    v.className = "media";
    v.autoplay = false;
    v.muted = true;
    v.playsInline = true;
    v.controls = false;
    v.preload = "auto";

    if (slide.source === "blob"){
      const blob = await idbGet(slide.id);
      if (blob){
        const u = URL.createObjectURL(blob);
        lastObjectUrl = u;
        v.src = u;
      } else {
        v.src = "";
      }
    } else {
      v.src = slide.url || "";
    }
    return v;
  } else {
    const img = document.createElement("img");
    img.className = "media";
    img.alt = slide.title || "slide";

    if (slide.source === "blob"){
      const blob = await idbGet(slide.id);
      if (blob){
        const u = URL.createObjectURL(blob);
        lastObjectUrl = u;
        img.src = u;
      } else {
        img.src = "";
      }
    } else {
      img.src = slide.url || "";
    }
    return img;
  }
}

// ---------- SHOW SLIDE ----------
async function showSlide(i){
  clearTimer();

  slides = sortSlides(loadMeta());
  settings = loadSettings();

  if (!slides.length){
    stage.innerHTML = "";
    const msg = document.createElement("div");
    msg.style.color = "rgba(255,255,255,.55)";
    msg.style.fontSize = "18px";
    msg.style.letterSpacing = ".4px";
    msg.textContent = "Tiada slide. Tambah media di Control Page.";
    stage.appendChild(msg);
    setStatus("Menunggu slides...");
    return;
  }

  idx = (i + slides.length) % slides.length;
  const slide = slides[idx];

  const el = await createMediaEl(slide);
  stage.appendChild(el);

  if (currentEl){
    const old = currentEl;
    old.classList.remove("show");
    setTimeout(() => {
      if (old && old.parentNode) old.parentNode.removeChild(old);
    }, 700);
  }
  currentEl = el;

  const reveal = () => requestAnimationFrame(() => el.classList.add("show"));

  if (slide.type === "video"){
    const v = el;

    const onMeta = () => {
      const dur = getDuration(slide, v);
      v.currentTime = 0;
      v.play().catch(()=>{});
      reveal();
      setStatus(`Slide ${idx+1}/${slides.length} • VIDEO • ${dur}s`);
      timer = setTimeout(() => showSlide(idx + 1), dur * 1000);
    };

    v.addEventListener("loadedmetadata", onMeta, { once:true });

    setTimeout(() => {
      if (!timer){
        const dur = getDuration(slide, v);
        v.currentTime = 0;
        v.play().catch(()=>{});
        reveal();
        setStatus(`Slide ${idx+1}/${slides.length} • VIDEO • ${dur}s`);
        timer = setTimeout(() => showSlide(idx + 1), dur * 1000);
      }
    }, 1200);

  } else {
    const img = el;

    img.onload = () => {
      const dur = getDuration(slide);
      reveal();
      setStatus(`Slide ${idx+1}/${slides.length} • IMAGE • ${dur}s`);
      timer = setTimeout(() => showSlide(idx + 1), dur * 1000);
    };
    img.onerror = () => {
      reveal();
      setStatus(`Slide ${idx+1}/${slides.length} • IMAGE error`);
      timer = setTimeout(() => showSlide(idx + 1), 1500);
    };

    setTimeout(() => {
      if (!timer){
        const dur = getDuration(slide);
        reveal();
        setStatus(`Slide ${idx+1}/${slides.length} • IMAGE • ${dur}s`);
        timer = setTimeout(() => showSlide(idx + 1), dur * 1000);
      }
    }, 300);
  }
}

// ---------- KEYBOARD ----------
window.addEventListener("keydown", (e) => {
  slides = sortSlides(loadMeta());
  if (!slides.length) return;
  if (e.key === "ArrowRight") showSlide(idx + 1);
  if (e.key === "ArrowLeft") showSlide(idx - 1);
  if (e.key === " ") {
    if (currentEl && currentEl.tagName === "VIDEO") {
      const v = currentEl;
      if (v.paused) v.play().catch(()=>{});
      else v.pause();
    }
  }
});

// ---------- SYNC ----------
window.addEventListener("storage", (e) => {
  if (e.key === META_KEY || e.key === SETTINGS_KEY){
    showSlide(idx);
  }
});
if (bc){
  bc.onmessage = () => showSlide(idx);
}

// ---------- INIT ----------
showSlide(0);
</script>
</body>
</html>
