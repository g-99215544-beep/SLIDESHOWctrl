<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slideshow Control (Local)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --muted:#9aa6c7;
      --accent:#7aa2ff;
      --accent2:#6ee7ff;
      --danger:#ff6b6b;
      --ok:#22c55e;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, #1b2550 0%, transparent 60%),
        radial-gradient(1200px 600px at 95% 10%, #0f3b4f 0%, transparent 55%),
        var(--bg);
      color:white;
      min-height:100vh;
    }
    header{
      padding:22px 24px 10px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
    }
    .title{display:flex; gap:12px; align-items:center;}
    .badge{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#0b1020;
      font-weight:700;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:.3px;
    }
    h1{font-size:22px; margin:0;}
    .sub{color:var(--muted); font-size:12px; margin-top:2px;}
    .wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      padding: 8px 24px 28px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .section-title{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1px;
      margin:2px 0 10px;
    }
    label{
      font-size:12px; color:var(--muted);
      display:block; margin:10px 0 6px;
    }
    input[type="text"], input[type="number"]{
      width:100%;
      background:#0c1430;
      border:1px solid var(--border);
      color:white;
      padding:10px 11px;
      border-radius:10px;
      outline:none;
    }
    input[type="file"]{
      width:100%;
      background:#0c1430;
      border:1px dashed var(--border);
      padding:12px;
      border-radius:10px;
      color:var(--muted);
    }
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .btn{
      background: linear-gradient(90deg, rgba(122,162,255,.18), rgba(110,231,255,.18));
      border:1px solid var(--border);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:12.5px;
      transition:.15s transform, .15s opacity, .15s border;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px); opacity:.9}
    .btn.accent{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#081225;
      border:none;
    }
    .btn.danger{
      background: rgba(255, 107, 107, .12);
      border: 1px solid rgba(255,107,107,.35);
      color:#ffd1d1;
    }
    .btn.small{padding:6px 8px; font-size:11px}
    .btn.ok{
      background: rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.35);
      color:#d9ffe9;
    }
    .muted{color:var(--muted); font-size:11.5px;}
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: calc(100vh - 160px);
      overflow:auto;
      padding-right:4px;
    }
    .slide-item{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:12px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .thumb{
      width:86px; height:60px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0a122b;
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted); font-size:10px;
    }
    .thumb img, .thumb video{
      width:100%; height:100%; object-fit:cover;
    }
    .meta h3{
      font-size:13.5px; margin:0 0 6px;
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      font-size:9.5px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .controls-line{
      display:flex; gap:6px; flex-wrap:wrap;
      align-items:center;
    }
    .duration-input{
      width:90px !important;
      padding:6px 8px !important;
      font-size:11px;
    }
    .divider{height:1px; background: var(--border); margin:12px 0;}
    .status{
      font-size:11.5px;
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .status.ok{border-color: rgba(34,197,94,.35)}
    .status.err{border-color: rgba(255,107,107,.35)}
    .link-btn{
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <span class="badge">LOCAL SLIDESHOW</span>
      <div>
        <h1>Control Panel</h1>
        <div class="sub">Tak perlu Firebase ‚Ä¢ Data simpan dalam laptop/browser anda</div>
      </div>
    </div>
    <div class="row" style="max-width:420px;">
      <a class="btn small link-btn" href="./view.html" target="_blank">üñ•Ô∏è Buka View Page</a>
      <button id="btnRefresh" class="btn small">‚Üª Refresh</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT -->
    <div>
      <div class="card">
        <div class="section-title">Settings Global</div>

        <label>Default masa setiap slide (saat)</label>
        <div class="row">
          <input id="defaultDuration" type="number" min="1" step="1" placeholder="Contoh: 6" />
          <button id="saveSettings" class="btn ok">Simpan</button>
        </div>
        <div class="muted">Jika slide tiada duration, sistem guna default ini.</div>

        <div class="divider"></div>

        <div class="section-title">Tambah dengan Upload (Local)</div>
        <label>Pilih gambar/video</label>
        <input id="fileInput" type="file" accept="image/*,video/*" />

        <label>Tajuk (optional)</label>
        <input id="uploadTitle" type="text" placeholder="Contoh: Hari Anugerah 2025" />

        <label>Duration khusus (optional)</label>
        <input id="uploadDuration" type="number" min="1" step="1" placeholder="Kosong = guna default" />

        <button id="btnUpload" class="btn accent" style="margin-top:10px;">‚¨ÜÔ∏è Simpan & Tambah Slide</button>

        <div class="divider"></div>

        <div class="section-title">Tambah dengan URL</div>
        <label>URL gambar/video (online)</label>
        <input id="urlInput" type="text" placeholder="https://..." />

        <label>Tajuk (optional)</label>
        <input id="urlTitle" type="text" placeholder="Contoh: Poster Program" />

        <label>Duration khusus (optional)</label>
        <input id="urlDuration" type="number" min="1" step="1" placeholder="Kosong = guna default" />

        <button id="btnAddUrl" class="btn" style="margin-top:10px;">‚ûï Tambah dari URL</button>

        <div class="divider"></div>

        <div class="section-title">Pengurusan Data</div>
        <div class="row">
          <button id="btnExport" class="btn">‚§ì Export JSON</button>
          <label class="btn" style="text-align:center;">
            ‚§í Import JSON
            <input id="importInput" type="file" accept="application/json" style="display:none;">
          </label>
        </div>
        <button id="btnClearAll" class="btn danger" style="margin-top:8px;">üßπ Padam Semua Slides</button>

        <div id="statusBox" class="status muted">Status: sedia.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="row" style="justify-content:space-between; gap:14px;">
          <div>
            <div class="section-title" style="margin-bottom:4px;">Senarai Slides</div>
            <div class="muted">Auto sync ke View Page (tab lain)</div>
          </div>
          <div class="row" style="max-width:260px;">
            <input id="searchInput" type="text" placeholder="Cari tajuk..." />
          </div>
        </div>

        <div class="divider"></div>
        <div id="slidesList" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   LOCAL SLIDESHOW STORAGE
   - metadata: localStorage
   - media blobs: IndexedDB
========================= */

const META_KEY = "slideshow_local_meta_v1";
const SETTINGS_KEY = "slideshow_local_settings_v1";
const DB_NAME = "slideshow_local_db_v1";
const STORE = "media";
const CHANNEL = "slideshow_local_channel_v1";

const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(CHANNEL) : null;

// ---------- IDB HELPERS ----------
function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPut(id, blob){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put(blob, id);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

async function idbGet(id){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).get(id);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

async function idbDelete(id){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

async function idbClear(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).clear();
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

// ---------- META HELPERS ----------
function loadMeta(){
  try { return JSON.parse(localStorage.getItem(META_KEY) || "[]"); }
  catch { return []; }
}
function saveMeta(arr){
  localStorage.setItem(META_KEY, JSON.stringify(arr));
  notifyUpdate();
}
function loadSettings(){
  try {
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null");
    return s || { defaultDurationSec: 6, updatedAt: Date.now() };
  } catch {
    return { defaultDurationSec: 6, updatedAt: Date.now() };
  }
}
function saveSettings(s){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({ ...s, updatedAt: Date.now() }));
  notifyUpdate();
}

function notifyUpdate(){
  if (bc) bc.postMessage({ type:"update", at: Date.now() });
}

// ---------- UTIL ----------
function nowId(){
  return `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
}
function isVideoFile(file){
  return (file.type || "").startsWith("video");
}
function isVideoUrl(url=""){
  const u = url.toLowerCase();
  return u.includes(".mp4") || u.includes(".webm") || u.includes(".ogg") || u.includes("video");
}
function sortSlides(list){
  return [...list].sort((a,b) => {
    const ao = Number(a.order ?? 999999);
    const bo = Number(b.order ?? 999999);
    if (ao !== bo) return ao - bo;
    return Number(a.createdAt ?? 0) - Number(b.createdAt ?? 0);
  });
}

// ---------- UI ELEMENTS ----------
const elDefaultDuration = document.getElementById("defaultDuration");
const btnSaveSettings = document.getElementById("saveSettings");
const btnUpload = document.getElementById("btnUpload");
const fileInput = document.getElementById("fileInput");
const uploadTitle = document.getElementById("uploadTitle");
const uploadDuration = document.getElementById("uploadDuration");

const urlInput = document.getElementById("urlInput");
const urlTitle = document.getElementById("urlTitle");
const urlDuration = document.getElementById("urlDuration");
const btnAddUrl = document.getElementById("btnAddUrl");

const slidesList = document.getElementById("slidesList");
const statusBox = document.getElementById("statusBox");
const btnRefresh = document.getElementById("btnRefresh");
const searchInput = document.getElementById("searchInput");

const btnExport = document.getElementById("btnExport");
const importInput = document.getElementById("importInput");
const btnClearAll = document.getElementById("btnClearAll");

let settings = loadSettings();
let cachedSlides = sortSlides(loadMeta());

// ---------- STATUS ----------
function setStatus(msg, type="muted"){
  statusBox.className = `status ${type}`;
  statusBox.textContent = `Status: ${msg}`;
}

// ---------- RENDER ----------
async function renderSlides(){
  cachedSlides = sortSlides(loadMeta());
  const q = (searchInput.value || "").toLowerCase().trim();
  const filtered = !q ? cachedSlides : cachedSlides.filter(s => (s.title || "").toLowerCase().includes(q));

  slidesList.innerHTML = "";

  if (!filtered.length){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "Tiada slide lagi. Tambah media di panel kiri.";
    slidesList.appendChild(empty);
    return;
  }

  for (const s of filtered){
    const item = document.createElement("div");
    item.className = "slide-item";

    const thumb = document.createElement("div");
    thumb.className = "thumb";

    // preview thumb
    if (s.type === "video"){
      const v = document.createElement("video");
      v.muted = true;
      v.playsInline = true;
      v.preload = "metadata";

      if (s.source === "blob"){
        const blob = await idbGet(s.id);
        if (blob){
          v.src = URL.createObjectURL(blob);
          v.onloadeddata = () => URL.revokeObjectURL(v.src);
        } else {
          v.replaceWith(document.createTextNode("No file"));
        }
      } else {
        v.src = s.url;
      }
      thumb.appendChild(v);
    } else {
      const img = document.createElement("img");
      if (s.source === "blob"){
        const blob = await idbGet(s.id);
        if (blob){
          const u = URL.createObjectURL(blob);
          img.src = u;
          img.onload = () => URL.revokeObjectURL(u);
        }
      } else {
        img.src = s.url;
      }
      img.alt = s.title || "slide";
      thumb.appendChild(img);
    }

    const meta = document.createElement("div");
    meta.className = "meta";

    const h3 = document.createElement("h3");
    const t = document.createElement("span");
    t.textContent = s.title || "(Tiada tajuk)";
    const pill = document.createElement("span");
    pill.className = "pill";
    pill.textContent = s.type === "video" ? "VIDEO" : "IMAGE";
    h3.appendChild(t);
    h3.appendChild(pill);

    const line1 = document.createElement("div");
    line1.className = "controls-line";

    const titleInput = document.createElement("input");
    titleInput.type = "text";
    titleInput.value = s.title || "";
    titleInput.placeholder = "Tajuk...";
    titleInput.style.flex = "1";
    titleInput.style.minWidth = "140px";

    const btnSaveTitle = document.createElement("button");
    btnSaveTitle.className = "btn small";
    btnSaveTitle.textContent = "Simpan Tajuk";
    btnSaveTitle.onclick = () => {
      const arr = loadMeta();
      const idx = arr.findIndex(x => x.id === s.id);
      if (idx !== -1){
        arr[idx].title = titleInput.value.trim();
        saveMeta(arr);
        setStatus("Tajuk dikemas kini.", "ok");
        renderSlides();
      }
    };

    line1.appendChild(titleInput);
    line1.appendChild(btnSaveTitle);

    const line2 = document.createElement("div");
    line2.className = "controls-line";
    line2.style.marginTop = "6px";

    const durLabel = document.createElement("span");
    durLabel.className = "muted";
    durLabel.textContent = "Masa (s)";

    const durationInput = document.createElement("input");
    durationInput.type = "number";
    durationInput.min = "1";
    durationInput.step = "1";
    durationInput.className = "duration-input";
    durationInput.placeholder = `Default ${settings.defaultDurationSec}s`;
    durationInput.value = s.durationSec ?? "";

    const btnSaveDur = document.createElement("button");
    btnSaveDur.className = "btn small ok";
    btnSaveDur.textContent = "Simpan Masa";
    btnSaveDur.onclick = () => {
      const arr = loadMeta();
      const idx = arr.findIndex(x => x.id === s.id);
      if (idx !== -1){
        arr[idx].durationSec = durationInput.value ? Number(durationInput.value) : null;
        saveMeta(arr);
        setStatus("Duration dikemas kini.", "ok");
        renderSlides();
      }
    };

    const btnUp = document.createElement("button");
    btnUp.className = "btn small";
    btnUp.textContent = "‚Üë";
    btnUp.onclick = () => {
      const arr = sortSlides(loadMeta());
      const i = arr.findIndex(x => x.id === s.id);
      if (i > 0){
        [arr[i-1], arr[i]] = [arr[i], arr[i-1]];
        arr.forEach((x, idx) => x.order = idx + 1);
        saveMeta(arr);
        setStatus("Urutan dikemas kini.", "ok");
        renderSlides();
      }
    };

    const btnDown = document.createElement("button");
    btnDown.className = "btn small";
    btnDown.textContent = "‚Üì";
    btnDown.onclick = () => {
      const arr = sortSlides(loadMeta());
      const i = arr.findIndex(x => x.id === s.id);
      if (i !== -1 && i < arr.length - 1){
        [arr[i+1], arr[i]] = [arr[i], arr[i+1]];
        arr.forEach((x, idx) => x.order = idx + 1);
        saveMeta(arr);
        setStatus("Urutan dikemas kini.", "ok");
        renderSlides();
      }
    };

    const btnDelete = document.createElement("button");
    btnDelete.className = "btn small danger";
    btnDelete.textContent = "Padam";
    btnDelete.onclick = async () => {
      if (!confirm("Padam slide ini?")) return;

      const arr = loadMeta().filter(x => x.id !== s.id);
      saveMeta(arr);

      if (s.source === "blob"){
        await idbDelete(s.id);
      }

      setStatus("Slide dipadam.", "ok");
      renderSlides();
    };

    line2.appendChild(durLabel);
    line2.appendChild(durationInput);
    line2.appendChild(btnSaveDur);
    line2.appendChild(btnUp);
    line2.appendChild(btnDown);
    line2.appendChild(btnDelete);

    meta.appendChild(h3);
    meta.appendChild(line1);
    meta.appendChild(line2);

    item.appendChild(thumb);
    item.appendChild(meta);
    slidesList.appendChild(item);
  }
}

// ---------- ADD FILE SLIDE ----------
btnUpload.onclick = async () => {
  const file = fileInput.files?.[0];
  if (!file){
    setStatus("Sila pilih fail gambar/video.", "err");
    return;
  }

  try{
    setStatus("Menyimpan media secara local...");

    const id = nowId();
    const type = isVideoFile(file) ? "video" : "image";

    // save blob into IDB
    await idbPut(id, file);

    const arr = sortSlides(loadMeta());
    const maxOrder = arr.length ? Math.max(...arr.map(s => Number(s.order ?? 0))) : 0;

    arr.push({
      id,
      title: uploadTitle.value.trim(),
      type,
      source: "blob",
      durationSec: uploadDuration.value ? Number(uploadDuration.value) : null,
      order: maxOrder + 1,
      createdAt: Date.now()
    });

    saveMeta(arr);

    fileInput.value = "";
    uploadTitle.value = "";
    uploadDuration.value = "";

    setStatus("Berjaya tambah slide local.", "ok");
    renderSlides();
  } catch(e){
    console.error(e);
    setStatus("Gagal simpan media. Storage browser mungkin penuh.", "err");
  }
};

// ---------- ADD URL SLIDE ----------
btnAddUrl.onclick = () => {
  const url = urlInput.value.trim();
  if (!url){
    setStatus("Sila isi URL.", "err");
    return;
  }

  const arr = sortSlides(loadMeta());
  const maxOrder = arr.length ? Math.max(...arr.map(s => Number(s.order ?? 0))) : 0;

  arr.push({
    id: nowId(),
    title: urlTitle.value.trim(),
    type: isVideoUrl(url) ? "video" : "image",
    source: "url",
    url,
    durationSec: urlDuration.value ? Number(urlDuration.value) : null,
    order: maxOrder + 1,
    createdAt: Date.now()
  });

  saveMeta(arr);

  urlInput.value = "";
  urlTitle.value = "";
  urlDuration.value = "";

  setStatus("Slide URL ditambah.", "ok");
  renderSlides();
};

// ---------- SETTINGS ----------
btnSaveSettings.onclick = () => {
  const val = Number(elDefaultDuration.value || 0);
  if (!val || val < 1){
    setStatus("Sila isi default duration yang sah.", "err");
    return;
  }
  settings.defaultDurationSec = val;
  saveSettings(settings);
  setStatus("Settings global disimpan.", "ok");
};

// ---------- EXPORT / IMPORT ----------
btnExport.onclick = async () => {
  const meta = sortSlides(loadMeta());
  const s = loadSettings();

  // NOTE: export only metadata (not blobs) for simplicity
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    settings: s,
    slides: meta
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "slideshow-local-export.json";
  a.click();
  URL.revokeObjectURL(url);

  setStatus("Export metadata berjaya.", "ok");
};

importInput.onchange = async () => {
  const file = importInput.files?.[0];
  if (!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);

    if (!data || !Array.isArray(data.slides)){
      setStatus("Fail import tidak sah.", "err");
      return;
    }

    // Only import metadata. Blob slides that refer to local blobs
    // will need re-upload if blobs not exists.
    localStorage.setItem(META_KEY, JSON.stringify(data.slides));
    if (data.settings){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(data.settings));
    }

    settings = loadSettings();
    elDefaultDuration.value = settings.defaultDurationSec ?? 6;

    notifyUpdate();
    setStatus("Import metadata berjaya. (Media blob perlu re-upload jika tiada)", "ok");
    renderSlides();
  } catch(e){
    console.error(e);
    setStatus("Import gagal.", "err");
  } finally {
    importInput.value = "";
  }
};

// ---------- CLEAR ALL ----------
btnClearAll.onclick = async () => {
  if (!confirm("Padam SEMUA slides & media local?")) return;

  localStorage.removeItem(META_KEY);
  await idbClear();

  notifyUpdate();
  setStatus("Semua slides dipadam.", "ok");
  renderSlides();
};

// ---------- REFRESH / SEARCH ----------
btnRefresh.onclick = () => {
  settings = loadSettings();
  elDefaultDuration.value = settings.defaultDurationSec ?? 6;
  renderSlides();
  setStatus("Paparan dikemas kini.", "ok");
};
searchInput.addEventListener("input", renderSlides);

// ---------- SYNC LISTENERS ----------
window.addEventListener("storage", (e) => {
  if (e.key === META_KEY || e.key === SETTINGS_KEY){
    settings = loadSettings();
    elDefaultDuration.value = settings.defaultDurationSec ?? 6;
    renderSlides();
  }
});
if (bc){
  bc.onmessage = () => {
    settings = loadSettings();
    elDefaultDuration.value = settings.defaultDurationSec ?? 6;
    renderSlides();
  };
}

// ---------- INIT ----------
(function init(){
  settings = loadSettings();
  elDefaultDuration.value = settings.defaultDurationSec ?? 6;
  renderSlides();
  setStatus("Sedia (Local Mode).", "ok");
})();
</script>
</body>
</html>
