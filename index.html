<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slideshow Control (Realtime DB - URL Only)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --muted:#9aa6c7;
      --accent:#7aa2ff;
      --accent2:#6ee7ff;
      --danger:#ff6b6b;
      --ok:#22c55e;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, #1b2550 0%, transparent 60%),
        radial-gradient(1200px 600px at 95% 10%, #0f3b4f 0%, transparent 55%),
        var(--bg);
      color:white;
      min-height:100vh;
    }
    header{
      padding:22px 24px 10px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
    }
    .title{display:flex; gap:12px; align-items:center;}
    .badge{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#0b1020;
      font-weight:700;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:.3px;
    }
    h1{font-size:22px; margin:0;}
    .sub{color:var(--muted); font-size:12px; margin-top:2px;}
    .wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      padding: 8px 24px 28px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .section-title{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1px;
      margin:2px 0 10px;
    }
    label{
      font-size:12px; color:var(--muted);
      display:block; margin:10px 0 6px;
    }
    input[type="text"], input[type="number"], input[type="url"]{
      width:100%;
      background:#0c1430;
      border:1px solid var(--border);
      color:white;
      padding:10px 11px;
      border-radius:10px;
      outline:none;
    }
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .btn{
      background: linear-gradient(90deg, rgba(122,162,255,.18), rgba(110,231,255,.18));
      border:1px solid var(--border);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:12.5px;
      transition:.15s transform, .15s opacity, .15s border;
      text-align:center;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0); opacity:.92}
    .btn.accent{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#081225;
      border:none;
    }
    .btn.danger{
      background: rgba(255, 107, 107, .12);
      border: 1px solid rgba(255,107,107,.35);
      color:#ffd1d1;
    }
    .btn.ok{
      background: rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.35);
      color:#d9ffe9;
    }
    .btn.small{padding:6px 8px; font-size:11px}
    .muted{color:var(--muted); font-size:11.5px;}
    .divider{height:1px; background: var(--border); margin:12px 0;}
    .status{
      font-size:11.5px;
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .status.ok{border-color: rgba(34,197,94,.35)}
    .status.err{border-color: rgba(255,107,107,.35)}

    /* List */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: calc(100vh - 160px);
      overflow:auto;
      padding-right:4px;
    }
    .slide-item{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:12px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .slide-item.dragging{
      opacity:.45;
      outline: 1px dashed rgba(255,255,255,.25);
    }
    .slide-item.drag-over{
      border-color: rgba(110,231,255,.45);
      background: rgba(110,231,255,.06);
    }
    .thumb{
      width:86px; height:60px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0a122b;
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted); font-size:10px;
      position:relative;
    }
    .thumb img, .thumb video{
      width:100%; height:100%; object-fit:cover;
    }
    .drag-handle{
      position:absolute;
      right:4px;
      top:4px;
      font-size:12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding:1px 4px;
      border-radius:6px;
      color: rgba(255,255,255,.75);
      cursor: grab;
      user-select:none;
    }
    .meta h3{
      font-size:13.5px; margin:0 0 6px;
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      font-size:9.5px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .controls-line{
      display:flex; gap:6px; flex-wrap:wrap;
      align-items:center;
    }
    .duration-input{
      width:90px !important;
      padding:6px 8px !important;
      font-size:11px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <span class="badge">REALTIME DB ‚Ä¢ URL ONLY</span>
      <div>
        <h1>Slideshow Control</h1>
        <div class="sub">Tambah slide guna link ‚Ä¢ Sync semua device</div>
      </div>
    </div>
    <div class="row" style="max-width:560px;">
      <button id="btnOpenAutoFS" class="btn small accent">üñ•Ô∏è Open View + Auto Fullscreen</button>
      <a id="btnOpenView" class="btn small" href="./view.html" target="_blank">Buka View</a>
      <button id="btnRefresh" class="btn small">‚Üª Refresh</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT -->
    <div>
      <div class="card">
        <div class="section-title">Settings Global</div>

        <label>Default masa setiap slide (saat)</label>
        <div class="row">
          <input id="defaultDuration" type="number" min="1" step="1" />
          <button id="saveSettings" class="btn ok">Simpan</button>
        </div>
        <div class="muted">Jika slide tiada duration, view akan guna default ini.</div>

        <label>Watermark text</label>
        <input id="wmText" type="text" placeholder="Contoh: SK SRI AMAN" />

        <label>Watermark logo URL (optional)</label>
        <input id="wmLogo" type="url" placeholder="https://...png/jpg" />

        <button id="saveWatermark" class="btn" style="margin-top:8px;">Simpan Watermark</button>

        <div class="divider"></div>

        <div class="section-title">Tambah Slide (URL)</div>
        <label>URL gambar/video</label>
        <input id="urlInput" type="url" placeholder="https://..." />

        <label>Tajuk (optional)</label>
        <input id="urlTitle" type="text" placeholder="Contoh: Poster Program" />

        <label>Duration khusus (optional)</label>
        <input id="urlDuration" type="number" min="1" step="1" placeholder="Kosong = guna default" />

        <button id="btnAddUrl" class="btn accent" style="margin-top:10px;">‚ûï Tambah Slide URL</button>

        <div class="divider"></div>

        <div class="section-title">Pengurusan</div>
        <button id="btnClearAll" class="btn danger">üßπ Padam Semua Slides</button>

        <div id="statusBox" class="status muted">Status: sedia.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="row" style="justify-content:space-between; gap:14px;">
          <div>
            <div class="section-title" style="margin-bottom:4px;">Senarai Slides</div>
            <div class="muted">Drag & drop untuk susun urutan</div>
          </div>
          <div class="row" style="max-width:260px;">
            <input id="searchInput" type="text" placeholder="Cari tajuk..." />
          </div>
        </div>

        <div class="divider"></div>
        <div id="slidesList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =========================
   FIREBASE CONFIG (USER)
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDYmt80huWPnfgyppPCKlC_lsrQAcu2zEw",
  authDomain: "operasi-asas-murid.firebaseapp.com",
  databaseURL: "https://operasi-asas-murid-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "operasi-asas-murid",
  storageBucket: "operasi-asas-murid.firebasestorage.app",
  messagingSenderId: "466962164666",
  appId: "1:466962164666:web:afe20ca7ae37298d154b83",
  measurementId: "G-4S5ZR7ZDKP"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =========================
   DB PATHS
========================= */
const ROOT = "slideshow";
const SLIDES_PATH = `${ROOT}/slides`;
const SETTINGS_PATH = `${ROOT}/settings`;

/* =========================
   UI
========================= */
const elDefaultDuration = document.getElementById("defaultDuration");
const btnSaveSettings = document.getElementById("saveSettings");

const wmText = document.getElementById("wmText");
const wmLogo = document.getElementById("wmLogo");
const btnSaveWatermark = document.getElementById("saveWatermark");

const urlInput = document.getElementById("urlInput");
const urlTitle = document.getElementById("urlTitle");
const urlDuration = document.getElementById("urlDuration");
const btnAddUrl = document.getElementById("btnAddUrl");

const slidesList = document.getElementById("slidesList");
const searchInput = document.getElementById("searchInput");

const btnClearAll = document.getElementById("btnClearAll");
const btnRefresh = document.getElementById("btnRefresh");

const btnOpenAutoFS = document.getElementById("btnOpenAutoFS");
const statusBox = document.getElementById("statusBox");

/* =========================
   STATE
========================= */
let settingsCache = {
  defaultDurationSec: 6,
  watermarkText: "SK SRI AMAN",
  watermarkLogoUrl: ""
};
let slidesCache = []; // array of {id, ...}

/* =========================
   HELPERS
========================= */
function setStatus(msg, type="muted"){
  statusBox.className = `status ${type}`;
  statusBox.textContent = `Status: ${msg}`;
}
function isVideoUrl(url=""){
  const u = url.toLowerCase();
  return u.endsWith(".mp4") || u.endsWith(".webm") || u.endsWith(".ogg") || u.includes("video");
}
function sortSlides(arr){
  return [...arr].sort((a,b)=>{
    const ao = Number(a.order ?? 999999);
    const bo = Number(b.order ?? 999999);
    if (ao !== bo) return ao - bo;
    return Number(a.createdAt ?? 0) - Number(b.createdAt ?? 0);
  });
}
function getMaxOrder(){
  if (!slidesCache.length) return 0;
  return Math.max(...slidesCache.map(s => Number(s.order ?? 0)));
}

/* =========================
   REALTIME LISTENERS
========================= */
db.ref(SETTINGS_PATH).on("value", snap=>{
  const v = snap.val() || {};
  settingsCache = {
    defaultDurationSec: Number(v.defaultDurationSec || 6),
    watermarkText: v.watermarkText || "SK SRI AMAN",
    watermarkLogoUrl: v.watermarkLogoUrl || ""
  };
  elDefaultDuration.value = settingsCache.defaultDurationSec;
  wmText.value = settingsCache.watermarkText;
  wmLogo.value = settingsCache.watermarkLogoUrl;
});

db.ref(SLIDES_PATH).on("value", snap=>{
  const obj = snap.val() || {};
  const arr = Object.keys(obj).map(id => ({ id, ...obj[id] }));
  slidesCache = sortSlides(arr);
  renderSlides();
});

/* =========================
   SETTINGS SAVE
========================= */
btnSaveSettings.onclick = async () => {
  const val = Number(elDefaultDuration.value || 0);
  if (!val || val < 1){
    setStatus("Default duration tidak sah.", "err");
    return;
  }
  try{
    await db.ref(SETTINGS_PATH).update({
      defaultDurationSec: val,
      updatedAt: Date.now()
    });
    setStatus("Default duration disimpan.", "ok");
  }catch(e){
    console.error(e);
    setStatus("Gagal simpan settings.", "err");
  }
};

btnSaveWatermark.onclick = async () => {
  try{
    await db.ref(SETTINGS_PATH).update({
      watermarkText: (wmText.value || "").trim() || "SK SRI AMAN",
      watermarkLogoUrl: (wmLogo.value || "").trim(),
      updatedAt: Date.now()
    });
    setStatus("Watermark disimpan.", "ok");
  }catch(e){
    console.error(e);
    setStatus("Gagal simpan watermark.", "err");
  }
};

/* =========================
   ADD URL SLIDE
========================= */
btnAddUrl.onclick = async () => {
  const url = (urlInput.value || "").trim();
  if (!url){
    setStatus("Sila isi URL.", "err");
    return;
  }

  try{
    const newRef = db.ref(SLIDES_PATH).push();
    const type = isVideoUrl(url) ? "video" : "image";
    const order = getMaxOrder() + 1;

    await newRef.set({
      title: (urlTitle.value || "").trim(),
      type,
      source: "url",
      url,
      durationSec: urlDuration.value ? Number(urlDuration.value) : null,
      order,
      createdAt: Date.now()
    });

    urlInput.value = "";
    urlTitle.value = "";
    urlDuration.value = "";

    setStatus("Slide URL ditambah.", "ok");
  }catch(e){
    console.error(e);
    setStatus("Gagal tambah slide URL.", "err");
  }
};

/* =========================
   DELETE SLIDE
========================= */
async function deleteSlide(slide){
  if (!confirm("Padam slide ini?")) return;
  try{
    await db.ref(`${SLIDES_PATH}/${slide.id}`).remove();
    setStatus("Slide dipadam.", "ok");
  }catch(e){
    console.error(e);
    setStatus("Gagal padam slide.", "err");
  }
}

/* =========================
   CLEAR ALL
========================= */
btnClearAll.onclick = async () => {
  if (!confirm("Padam SEMUA slides?")) return;
  try{
    await db.ref(SLIDES_PATH).remove();
    setStatus("Semua slides dipadam.", "ok");
  }catch(e){
    console.error(e);
    setStatus("Gagal clear all.", "err");
  }
};

/* =========================
   DRAG & DROP REORDER
========================= */
let dragSrcId = null;

function attachDnD(item){
  item.addEventListener("dragstart", (e)=>{
    dragSrcId = item.dataset.id;
    item.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    try{ e.dataTransfer.setData("text/plain", dragSrcId); }catch{}
  });

  item.addEventListener("dragend", ()=>{
    item.classList.remove("dragging");
    [...document.querySelectorAll(".slide-item.drag-over")]
      .forEach(el=>el.classList.remove("drag-over"));
  });

  item.addEventListener("dragover", (e)=>{
    e.preventDefault();
    item.classList.add("drag-over");
    e.dataTransfer.dropEffect = "move";
  });

  item.addEventListener("dragleave", ()=>{
    item.classList.remove("drag-over");
  });

  item.addEventListener("drop", (e)=>{
    e.preventDefault();
    item.classList.remove("drag-over");

    const fromId = dragSrcId || (()=>{
      try{ return e.dataTransfer.getData("text/plain"); }catch{ return null; }
    })();
    const toId = item.dataset.id;
    if (!fromId || !toId || fromId === toId) return;

    const fromEl = slidesList.querySelector(`.slide-item[data-id="${fromId}"]`);
    const toEl = slidesList.querySelector(`.slide-item[data-id="${toId}"]`);
    if (!fromEl || !toEl) return;

    const rect = toEl.getBoundingClientRect();
    const before = (e.clientY < rect.top + rect.height/2);

    if (before) slidesList.insertBefore(fromEl, toEl);
    else slidesList.insertBefore(fromEl, toEl.nextSibling);

    persistOrderFromDOM();
  });
}

async function persistOrderFromDOM(){
  const ids = [...slidesList.querySelectorAll(".slide-item")]
    .map(el => el.dataset.id);

  const visibleSet = new Set(ids);
  const all = sortSlides(slidesCache);
  const map = new Map(all.map(s => [s.id, s]));

  const newSeq = [];
  ids.forEach(id=>{
    const s = map.get(id);
    if (s) newSeq.push(s);
  });
  all.forEach(s=>{
    if (!visibleSet.has(s.id)) newSeq.push(s);
  });

  const updates = {};
  newSeq.forEach((s, i)=>{
    updates[`${SLIDES_PATH}/${s.id}/order`] = i + 1;
  });

  try{
    await db.ref().update(updates);
    setStatus("Urutan disimpan (Realtime).", "ok");
  }catch(e){
    console.error(e);
    setStatus("Gagal simpan urutan.", "err");
  }
}

/* =========================
   RENDER LIST
========================= */
function renderSlides(){
  const q = (searchInput.value || "").toLowerCase().trim();
  const filtered = !q ? slidesCache : slidesCache.filter(s => (s.title || "").toLowerCase().includes(q));

  slidesList.innerHTML = "";

  if (!filtered.length){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "Tiada slide lagi.";
    slidesList.appendChild(empty);
    return;
  }

  filtered.forEach(slide=>{
    const item = document.createElement("div");
    item.className = "slide-item";
    item.dataset.id = slide.id;
    item.draggable = true;

    const thumb = document.createElement("div");
    thumb.className = "thumb";

    const handle = document.createElement("span");
    handle.className = "drag-handle";
    handle.textContent = "‚Üï";
    thumb.appendChild(handle);

    if (slide.type === "video"){
      const v = document.createElement("video");
      v.muted = true;
      v.playsInline = true;
      v.preload = "metadata";
      v.src = slide.url || "";
      thumb.appendChild(v);
    } else {
      const img = document.createElement("img");
      img.src = slide.url || "";
      img.alt = slide.title || "slide";
      thumb.appendChild(img);
    }

    const meta = document.createElement("div");
    meta.className = "meta";

    const h3 = document.createElement("h3");
    const t = document.createElement("span");
    t.textContent = slide.title || "(Tiada tajuk)";
    const pill = document.createElement("span");
    pill.className = "pill";
    pill.textContent = slide.type === "video" ? "VIDEO" : "IMAGE";
    h3.appendChild(t);
    h3.appendChild(pill);

    const line1 = document.createElement("div");
    line1.className = "controls-line";

    const titleInput = document.createElement("input");
    titleInput.type = "text";
    titleInput.value = slide.title || "";
    titleInput.placeholder = "Tajuk...";
    titleInput.style.flex = "1";
    titleInput.style.minWidth = "140px";

    const btnSaveTitle = document.createElement("button");
    btnSaveTitle.className = "btn small";
    btnSaveTitle.textContent = "Simpan Tajuk";
    btnSaveTitle.onclick = async ()=>{
      try{
        await db.ref(`${SLIDES_PATH}/${slide.id}`).update({ title: titleInput.value.trim() });
        setStatus("Tajuk dikemas kini.", "ok");
      }catch(e){
        console.error(e);
        setStatus("Gagal simpan tajuk.", "err");
      }
    };

    line1.appendChild(titleInput);
    line1.appendChild(btnSaveTitle);

    const line2 = document.createElement("div");
    line2.className = "controls-line";
    line2.style.marginTop = "6px";

    const durLabel = document.createElement("span");
    durLabel.className = "muted";
    durLabel.textContent = "Masa (s)";

    const durationInput = document.createElement("input");
    durationInput.type = "number";
    durationInput.min = "1";
    durationInput.step = "1";
    durationInput.className = "duration-input";
    durationInput.placeholder = `Default ${settingsCache.defaultDurationSec}s`;
    durationInput.value = slide.durationSec ?? "";

    const btnSaveDur = document.createElement("button");
    btnSaveDur.className = "btn small ok";
    btnSaveDur.textContent = "Simpan Masa";
    btnSaveDur.onclick = async ()=>{
      try{
        await db.ref(`${SLIDES_PATH}/${slide.id}`).update({
          durationSec: durationInput.value ? Number(durationInput.value) : null
        });
        setStatus("Duration dikemas kini.", "ok");
      }catch(e){
        console.error(e);
        setStatus("Gagal simpan duration.", "err");
      }
    };

    const btnDelete = document.createElement("button");
    btnDelete.className = "btn small danger";
    btnDelete.textContent = "Padam";
    btnDelete.onclick = ()=> deleteSlide(slide);

    line2.appendChild(durLabel);
    line2.appendChild(durationInput);
    line2.appendChild(btnSaveDur);
    line2.appendChild(btnDelete);

    meta.appendChild(h3);
    meta.appendChild(line1);
    meta.appendChild(line2);

    item.appendChild(thumb);
    item.appendChild(meta);

    attachDnD(item);
    slidesList.appendChild(item);
  });
}

/* =========================
   TOP BUTTONS
========================= */
searchInput.addEventListener("input", renderSlides);

btnRefresh.onclick = ()=>{
  renderSlides();
  setStatus("Refresh paparan.", "ok");
};

btnOpenAutoFS.onclick = ()=>{
  const url = `./view.html?autofs=1&t=${Date.now()}`;
  window.open(url, "_blank", "noopener");
  setStatus("View dibuka (Auto Fullscreen mode).", "ok");
};

/* =========================
   INIT DEFAULT SETTINGS (if empty)
========================= */
(async function bootstrap(){
  try{
    const snap = await db.ref(SETTINGS_PATH).once("value");
    if (!snap.exists()){
      await db.ref(SETTINGS_PATH).set({
        defaultDurationSec: 6,
        watermarkText: "SK SRI AMAN",
        watermarkLogoUrl: "",
        createdAt: Date.now()
      });
    }
  }catch(e){
    console.warn(e);
  }
})();
</script>
</body>
</html>
