<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slideshow Control (Local)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --muted:#9aa6c7;
      --accent:#7aa2ff;
      --accent2:#6ee7ff;
      --danger:#ff6b6b;
      --ok:#22c55e;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, #1b2550 0%, transparent 60%),
        radial-gradient(1200px 600px at 95% 10%, #0f3b4f 0%, transparent 55%),
        var(--bg);
      color:white;
      min-height:100vh;
    }
    header{
      padding:22px 24px 10px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
    }
    .title{display:flex; gap:12px; align-items:center;}
    .badge{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#0b1020;
      font-weight:700;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:.3px;
    }
    h1{font-size:22px; margin:0;}
    .sub{color:var(--muted); font-size:12px; margin-top:2px;}
    .wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      padding: 8px 24px 28px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .section-title{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1px;
      margin:2px 0 10px;
    }
    label{
      font-size:12px; color:var(--muted);
      display:block; margin:10px 0 6px;
    }
    input[type="text"], input[type="number"]{
      width:100%;
      background:#0c1430;
      border:1px solid var(--border);
      color:white;
      padding:10px 11px;
      border-radius:10px;
      outline:none;
    }
    input[type="file"]{
      width:100%;
      background:#0c1430;
      border:1px dashed var(--border);
      padding:12px;
      border-radius:10px;
      color:var(--muted);
    }
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .btn{
      background: linear-gradient(90deg, rgba(122,162,255,.18), rgba(110,231,255,.18));
      border:1px solid var(--border);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:12.5px;
      transition:.15s transform, .15s opacity, .15s border;
      text-align:center;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px); opacity:.9}
    .btn.accent{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#081225;
      border:none;
    }
    .btn.danger{
      background: rgba(255, 107, 107, .12);
      border: 1px solid rgba(255,107,107,.35);
      color:#ffd1d1;
    }
    .btn.small{padding:6px 8px; font-size:11px}
    .btn.ok{
      background: rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.35);
      color:#d9ffe9;
    }
    .muted{color:var(--muted); font-size:11.5px;}
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: calc(100vh - 160px);
      overflow:auto;
      padding-right:4px;
    }
    .slide-item{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:12px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .slide-item.dragging{
      opacity:.45;
      outline: 1px dashed rgba(255,255,255,.25);
    }
    .slide-item.drag-over{
      border-color: rgba(110,231,255,.45);
      background: rgba(110,231,255,.06);
    }
    .thumb{
      width:86px; height:60px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0a122b;
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted); font-size:10px;
      position:relative;
    }
    .thumb img, .thumb video{
      width:100%; height:100%; object-fit:cover;
    }
    .drag-handle{
      position:absolute;
      right:4px;
      top:4px;
      font-size:12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding:1px 4px;
      border-radius:6px;
      color: rgba(255,255,255,.75);
      cursor: grab;
      user-select:none;
    }
    .meta h3{
      font-size:13.5px; margin:0 0 6px;
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      font-size:9.5px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .controls-line{
      display:flex; gap:6px; flex-wrap:wrap;
      align-items:center;
    }
    .duration-input{
      width:90px !important;
      padding:6px 8px !important;
      font-size:11px;
    }
    .divider{height:1px; background: var(--border); margin:12px 0;}
    .status{
      font-size:11.5px;
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .status.ok{border-color: rgba(34,197,94,.35)}
    .status.err{border-color: rgba(255,107,107,.35)}
    .link-btn{
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <span class="badge">LOCAL SLIDESHOW</span>
      <div>
        <h1>Control Panel</h1>
        <div class="sub">Tak perlu Firebase ‚Ä¢ Drag & Drop untuk susun slide</div>
      </div>
    </div>
    <div class="row" style="max-width:560px;">
      <button id="btnOpenAutoFS" class="btn small accent">üñ•Ô∏è Open View + Auto Fullscreen</button>
      <a class="btn small link-btn" href="./view.html" target="_blank">Buka View</a>
      <button id="btnRefresh" class="btn small">‚Üª Refresh</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT -->
    <div>
      <div class="card">
        <div class="section-title">Settings Global</div>

        <label>Default masa setiap slide (saat)</label>
        <div class="row">
          <input id="defaultDuration" type="number" min="1" step="1" placeholder="Contoh: 6" />
          <button id="saveSettings" class="btn ok">Simpan</button>
        </div>
        <div class="muted">Jika slide tiada duration, sistem guna default ini.</div>

        <div class="divider"></div>

        <div class="section-title">Tambah dengan Upload (Local)</div>
        <label>Pilih gambar/video</label>
        <input id="fileInput" type="file" accept="image/*,video/*" />

        <label>Tajuk (optional)</label>
        <input id="uploadTitle" type="text" placeholder="Contoh: Hari Anugerah 2025" />

        <label>Duration khusus (optional)</label>
        <input id="uploadDuration" type="number" min="1" step="1" placeholder="Kosong = guna default" />

        <button id="btnUpload" class="btn accent" style="margin-top:10px;">‚¨ÜÔ∏è Simpan & Tambah Slide</button>

        <div class="divider"></div>

        <div class="section-title">Tambah dengan URL</div>
        <label>URL gambar/video (online)</label>
        <input id="urlInput" type="text" placeholder="https://..." />

        <label>Tajuk (optional)</label>
        <input id="urlTitle" type="text" placeholder="Contoh: Poster Program" />

        <label>Duration khusus (optional)</label>
        <input id="urlDuration" type="number" min="1" step="1" placeholder="Kosong = guna default" />

        <button id="btnAddUrl" class="btn" style="margin-top:10px;">‚ûï Tambah dari URL</button>

        <div class="divider"></div>

        <div class="section-title">Pengurusan Data</div>
        <div class="row">
          <button id="btnExport" class="btn">‚§ì Export JSON</button>
          <label class="btn">
            ‚§í Import JSON
            <input id="importInput" type="file" accept="application/json" style="display:none;">
          </label>
        </div>
        <button id="btnClearAll" class="btn danger" style="margin-top:8px;">üßπ Padam Semua Slides</button>

        <div id="statusBox" class="status muted">Status: sedia.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="row" style="justify-content:space-between; gap:14px;">
          <div>
            <div class="section-title" style="margin-bottom:4px;">Senarai Slides</div>
            <div class="muted">Drag & drop pada item untuk susun urutan</div>
          </div>
          <div class="row" style="max-width:260px;">
            <input id="searchInput" type="text" placeholder="Cari tajuk..." />
          </div>
        </div>

        <div class="divider"></div>
        <div id="slidesList" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   LOCAL SLIDESHOW STORAGE
   - metadata: localStorage
   - media blobs: IndexedDB
========================= */

const META_KEY = "slideshow_local_meta_v1";
const SETTINGS_KEY = "slideshow_local_settings_v1";
const DB_NAME = "slideshow_local_db_v1";
const STORE = "media";
const CHANNEL = "slideshow_local_channel_v1";

const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(CHANNEL) : null;

// ---------- IDB HELPERS ----------
function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contai
